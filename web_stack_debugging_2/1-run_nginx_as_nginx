#!/usr/bin/env bash
# Ensure script runs as root
if [ "$(id -u)" -ne 0 ]; then
    echo "This script must be run as root!"
    exit 1
fi

# Create nginx user if it doesn't exist
if ! id -u nginx >/dev/null 2>&1; then
    useradd -r -d /var/www -s /sbin/nologin nginx
fi

# Modify Nginx config to:
# - Run as nginx user
# - Listen on port 8080

NGINX_CONF="/etc/nginx/nginx.conf"

if [ -f "$NGINX_CONF" ]; then
    # Update 'user' directive to run as nginx user
    sed -i 's/^user .*/user nginx;/' "$NGINX_CONF"

    # Update default server block to listen on port 8080
    sed -i 's/listen 80;/listen 8080;/g' /etc/nginx/sites-available/default
    sed -i 's/listen \[::\]:80;/listen \[::\]:8080;/g' /etc/nginx/sites-available/default
else
    echo "Error: Nginx configuration file not found!"
    exit 1
fi

# Restart Nginx to apply changes
systemctl restart nginx

# Confirm Nginx is running as the nginx user
ps aux | grep [n]ginx

