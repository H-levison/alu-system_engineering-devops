#!/usr/bin/env bash
# Check if Nginx is installed
if ! dpkg -l | grep -q nginx; then
    echo "Installing Nginx..."
    sudo apt update
    sudo apt install -y nginx
else
    echo "Nginx is already installed."
fi

# Start Nginx if it's not running
if ! systemctl is-active --quiet nginx; then
    echo "Starting Nginx service..."
    sudo systemctl start nginx
else
    echo "Nginx is already running."
fi

# Configure Nginx to listen on all IP addresses on port 80
echo "Configuring Nginx to listen on port 80..."
sudo sed -i 's/listen 127.0.0.1:80;/listen 0.0.0.0:80;/' /etc/nginx/sites-available/default

# Allow traffic on port 80 through the firewall
echo "Configuring firewall to allow traffic on port 80..."
sudo ufw allow 80/tcp
sudo ufw reload

# Restart Nginx to apply changes
echo "Restarting Nginx..."
sudo systemctl restart nginx

# Verify Nginx is listening on port 80
echo "Verifying if Nginx is listening on port 80..."
if sudo netstat -tuln | grep -q ':80'; then
    echo "Nginx is listening on port 80."
else
    echo "Nginx is NOT listening on port 80."
    exit 1
fi

# Check if Nginx is returning a valid HTTP response
echo "Checking if Nginx is serving a page on port 80..."
HTTP_STATUS=$(curl -o /dev/null -s -w "%{http_code}" http://localhost:80)

if [ "$HTTP_STATUS" -eq 200 ]; then
    echo "Nginx is serving the page successfully with HTTP 200."
else
    echo "Nginx returned HTTP status $HTTP_STATUS."
    exit 2
fi

